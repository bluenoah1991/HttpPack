{"version":3,"sources":["../src/HttpPack.js"],"names":["MAX_REQUEST_NUMBER","HttpPack","opts","callback","undefined","requestCallbackHook","max_request_number","storage","defaultRequestOpts","requestOpts","merge","heartbeat","loopHandle","setTimeout","loop","bind","data","qos","pack","uniqueId","save","retry_times","retry_pack","cloneDeep","timestamp","add","msg_type","msg_id","payload","packs","unconfirmed","forEach","retry","body","combine","length","assign","requestCallback","Buffer","concat","map","buffer","offset","push","total_length","error","response","split","reply","receive","confirm","release"],"mappings":"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","file":"HttpPack.js","sourcesContent":["import _ from 'lodash';\r\nimport moment from 'moment';\r\n\r\nimport {Request, DefaultRequestOpts} from './HttpClient';\r\nimport MemoryStorage from './MemoryStorage';\r\nimport {\r\n    Encode, \r\n    Decode,\r\n    MSG_TYPE_SEND,\r\n    MSG_TYPE_ACK,\r\n    MSG_TYPE_RECEIVED,\r\n    MSG_TYPE_RELEASE,\r\n    MSG_TYPE_COMPLETED,\r\n    QoS0, QoS1, QoS2\r\n} from './Protocol';\r\n\r\nconst MAX_REQUEST_NUMBER = 20;\r\n\r\nexport default class HttpPack {\r\n    constructor(opts){\r\n        this.callback = opts.callback != undefined ? opts.callback : function(){};\r\n        this.requestCallbackHook = opts.requestCallbackHook != undefined ? opts.requestCallbackHook : function(){};\r\n        this.max_request_number = opts.max_request_number != undefined ? opts.max_request_number : MAX_REQUEST_NUMBER;\r\n        this.storage = opts.storage != undefined ? opts.storage : new MemoryStorage();\r\n        this.defaultRequestOpts = DefaultRequestOpts;\r\n        this.requestOpts = opts.requestOpts != undefined ? _.merge({}, this.defaultRequestOpts, opts.requestOpts) : this.defaultRequestOpts;\r\n        this.heartbeat = opts.heartbeat != undefined ? opts.heartbeat : 1000;\r\n        this.loopHandle = setTimeout(this.loop.bind(this), this.heartbeat);\r\n    }\r\n\r\n    commit(data, qos = 0){\r\n        let pack = Encode(MSG_TYPE_SEND, qos, 0, this.storage.uniqueId(), data);\r\n        this.storage.save(pack);\r\n    }\r\n\r\n    retry(pack){\r\n        if(pack.qos == QoS0){\r\n            return null;\r\n        } else {\r\n            if(pack.retry_times != undefined && pack.retry_times > 0) {\r\n                let retry_pack = _.cloneDeep(pack);\r\n                retry_pack.retry_times++;\r\n                retry_pack.timestamp = moment().add(retry_pack.retry_times * 5, 's');\r\n                return retry_pack;\r\n            } else {\r\n                let retry_pack = Encode(pack.msg_type, pack.qos, 1, pack.msg_id, pack.payload);\r\n                retry_pack.retry_times = 1;\r\n                retry_pack.timestamp = moment().add(retry_pack.retry_times * 5, 's');\r\n                return retry_pack;\r\n            }\r\n        }\r\n    }\r\n\r\n    loop(){\r\n        let packs = this.storage.unconfirmed(this.max_request_number);\r\n        packs.forEach(function(pack){\r\n            let retry_pack = this.retry(pack);\r\n            if(retry_pack != undefined){\r\n                this.storage.save(retry_pack);\r\n            }\r\n        }.bind(this));\r\n\r\n        let body = this.combine(packs);\r\n        if(body.length === 0){\r\n            body = '';\r\n        }\r\n        Request(_.assign({}, this.requestOpts, {\r\n            body: body\r\n        }), this.requestCallback.bind(this));\r\n    }\r\n\r\n    // combine packs return body\r\n    combine(packs){\r\n        return Buffer.concat(packs.map(function(pack){\r\n            return pack.buffer;\r\n        }));\r\n    }\r\n\r\n    // split body return packs\r\n    split(body){\r\n        let packs = [];\r\n        let offset = 0;\r\n        while(offset < body.length){\r\n            let pack = Decode(body, offset);\r\n            packs.push(pack);\r\n            offset += pack.total_length;\r\n        }\r\n        return packs;\r\n    }\r\n\r\n    requestCallback(error, response, body){\r\n        this.requestCallbackHook(error, response, body);\r\n        if(body != undefined){\r\n            let packs = this.split(body);\r\n            packs.forEach(function(pack){\r\n                if(pack.msg_type == MSG_TYPE_SEND){\r\n                    if(pack.qos == QoS0){\r\n                        this.callback(pack.payload, response);\r\n                    } else if(pack.qos == QoS1){\r\n                        let reply = Encode(MSG_TYPE_ACK, QoS0, 0, pack.msg_id);\r\n                        this.storage.save(reply);\r\n                        this.callback(pack.payload, response);\r\n                    } else if(pack.qos == QoS2){\r\n                        this.storage.receive(pack.msg_id, pack.payload);\r\n                        let reply = Encode(MSG_TYPE_RECEIVED, QoS0, 0, pack.msg_id);\r\n                        this.storage.save(reply);\r\n                    }\r\n                } else if(pack.msg_type == MSG_TYPE_ACK){\r\n                    this.storage.confirm(pack.msg_id);\r\n                } else if(pack.msg_type == MSG_TYPE_RECEIVED){\r\n                    this.storage.confirm(pack.msg_id);\r\n                    let reply = Encode(MSG_TYPE_RELEASE, QoS1, 0, pack.msg_id);\r\n                    this.storage.save(reply);\r\n                } else if(pack.msg_type == MSG_TYPE_RELEASE){\r\n                    let payload = this.storage.release(pack.msg_id);\r\n                    if(payload != undefined){\r\n                        this.callback(payload, response);\r\n                    }\r\n                    let reply = Encode(MSG_TYPE_COMPLETED, QoS0, 0, pack.msg_id);\r\n                    this.storage.save(reply);\r\n                } else if(pack.msg_type == MSG_TYPE_COMPLETED){\r\n                    this.storage.confirm(pack.msg_id);\r\n                }\r\n            }.bind(this));\r\n        }\r\n        this.loopHandle = setTimeout(this.loop.bind(this), this.heartbeat);\r\n    }\r\n}"]}