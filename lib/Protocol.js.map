{"version":3,"sources":["../src/Protocol.js"],"names":["Encode","Decode","MSG_TYPE_SEND","MSG_TYPE_ACK","MSG_TYPE_RECEIVED","MSG_TYPE_RELEASE","MSG_TYPE_COMPLETED","QoS0","QoS1","QoS2","isBrowser","Function","allocUnsafe","val","Buffer","msgType","qos","dup","identifier","payload","remainingLength","undefined","length","buffer","fixedHeader","writeUInt8","writeUInt16BE","copy","packet","Packet","offset","readInt8","readUInt16BE","totalLength","retryTimes","timestamp","isConfirmed"],"mappings":"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","file":"Protocol.js","sourcesContent":["/**\n * bit           | 7 | 6 | 5 | 4 |  3  |  2  |    1     |    0     |\n * byte1         | Message Type  | QoS Level | Dup flag | Reserved |\n * byte1 - byte2 |              Message Identifiers\n * byte3 - byte4 |              Remaining Length\n * \n * * * Message Type * *\n * 0 Reserved\n * 1 Send\n * 2 Ack\n * 3 Received\n * 4 Released\n * 5 Completed\n * \n * * * QoS Level * *\n * 0 1 2\n * \n * * * Dup flag * *\n * 0 1\n * \n * * * Message Identifiers * *\n * 0 - 2^32\n */\n\nexport const MSG_TYPE_SEND = 0x1;\nexport const MSG_TYPE_ACK = 0x2;\nexport const MSG_TYPE_RECEIVED = 0x3;\nexport const MSG_TYPE_RELEASE = 0x4;\nexport const MSG_TYPE_COMPLETED = 0x5;\n\nexport const QoS0 = 0;\nexport const QoS1 = 1;\nexport const QoS2 = 2;\n\nvar isBrowser=new Function(\"try {return this===window;} catch(e) {return false;}\");\n\nfunction allocUnsafe(val){\n    // check whether is running under nodejs or browser\n    if (isBrowser()) {\n        // https://github.com/feross/buffer\n        return new Buffer(val);\n    } else {\n        return Buffer.allocUnsafe(val);\n    }\n}\n\nexport function Encode(msgType = MSG_TYPE_SEND, qos = QoS0, dup = 0, identifier = 0, payload){\n    let remainingLength = 0;\n    if(payload != undefined){\n        remainingLength = payload.length;\n    }\n    let buffer = allocUnsafe(5 + remainingLength);\n    let fixedHeader = (msgType << 4) | (qos << 2) | (dup << 1);\n    buffer.writeUInt8(fixedHeader, 0);\n    buffer.writeUInt16BE(identifier, 1);\n    buffer.writeUInt16BE(remainingLength, 3);\n    if(payload != undefined){\n        payload.copy(buffer, 5, 0, remainingLength);\n    }\n    let packet = new Packet(msgType, qos, dup, identifier, payload);\n    packet.buffer = buffer;\n    return packet;\n}\n\nexport function Decode(buffer, offset = 0){\n    let fixedHeader = buffer.readInt8(offset);\n    let msgType = fixedHeader >> 4;\n    let qos = (fixedHeader & 0xf) >> 2;\n    let dup = (fixedHeader & 0x3) >> 1;\n    let identifier = buffer.readUInt16BE(offset + 1);\n    let remainingLength = buffer.readUInt16BE(offset + 3);\n    let payload = allocUnsafe(remainingLength);\n    buffer.copy(payload, 0, offset + 5, offset + 5 + remainingLength);\n    let packet = new Packet(msgType, qos, dup, identifier, payload);\n    packet.buffer = buffer;\n    return packet;\n}\n\nexport class Packet{\n    constructor(msgType = MSG_TYPE_SEND, qos = QoS0, dup = 0, identifier = 0, payload){\n        this.msgType = msgType;\n        this.qos = qos;\n        this.dup = dup;\n        this.identifier = identifier;\n        this.payload = payload;\n        if(payload == undefined){\n            this.remainingLength = 0;\n        } else {\n            this.remainingLength = payload.length;\n        }\n        this.totalLength = 5 + this.remainingLength;\n        this.retryTimes = 0;\n        this.timestamp = 0;\n        this.isConfirmed = false;\n        this.buffer = null;\n    }\n}"]}